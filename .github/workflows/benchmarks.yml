name: Benchmarks

on:
  # Disabled on push/PR until path issues resolved
  # push:
  #   branches: [ main ]
  # pull_request:
  #   branches: [ main ]
  schedule:
    # Run weekly on Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  contents: write  # Needed to commit benchmark results

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libglfw3-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libcurl4-openssl-dev \
          xorg-dev \
          libbenchmark-dev

    - name: Cache dependencies
      uses: actions/cache@v5
      with:
        path: |
          external/imgui
          external/json
          external/implot
        key: benchmark-deps-imgui-1.92.4-json-3.11.3-implot-0.17
        restore-keys: |
          benchmark-deps-

    - name: Setup ImGui
      run: |
        if [ ! -d "external/imgui" ]; then
          mkdir -p external
          cd external
          git clone --branch v1.92.4 --depth 1 https://github.com/ocornut/imgui.git
        fi

    - name: Setup nlohmann/json
      run: |
        if [ ! -d "external/json" ]; then
          mkdir -p external
          cd external
          git clone --branch v3.11.3 --depth 1 https://github.com/nlohmann/json.git
        fi

    - name: Setup ImPlot
      run: |
        if [ ! -d "external/implot" ]; then
          mkdir -p external
          cd external
          git clone --branch v0.17 --depth 1 https://github.com/epezent/implot.git
        fi

    - name: Configure with benchmarks
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_BENCHMARKS=ON \
          -DBUILD_TESTS=OFF

    - name: Build
      run: cmake --build build --parallel

    - name: Run benchmarks
      run: |
        cd build
        ./benchmarks/MetaImGUI_benchmarks \
          --benchmark_out=benchmark_results.json \
          --benchmark_out_format=json \
          --benchmark_repetitions=3

    - name: Store benchmark result
      uses: benchmark-action/github-action-benchmark@v1
      with:
        tool: 'googlebenchmark'
        output-file-path: build/benchmark_results.json
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: false
        alert-threshold: '150%'
        comment-on-alert: true
        fail-on-alert: false
        alert-comment-cc-users: '@andynicholson'

    - name: Upload benchmark results
      uses: actions/upload-artifact@v6
      with:
        name: benchmark-results
        path: build/benchmark_results.json
        retention-days: 90

    - name: Generate summary
      run: |
        echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        cd build
        ./benchmarks/MetaImGUI_benchmarks --benchmark_filter=. | head -n 50 >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š Full results available in artifacts" >> $GITHUB_STEP_SUMMARY

